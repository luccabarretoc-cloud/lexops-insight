<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Jur√≠dico | LexOpsInsight</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/css/app.css">

    <script id="consolidated-data" type="application/json"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 500: 'var(--brand-500)', 600: 'var(--brand-600)' }
                    }
                }
            }
        }
    </script>

    <style>
        :root { 
            --brand-500: #4f46e5; 
            --brand-600: #4338ca;
            --layout-bg: #e2e8f0;
            --layout-card: #ffffff;
            --layout-text: #111827;
            --layout-border: #E5E7EB;
            --layout-accent: #F3F4F6;
            --layout-sidebar: #0f172a;
            --layout-sidebar-text: #f8fafc;
            --layout-sidebar-border: #1e293b;
        }

        <script src="js/app.js"></script>
        
        body { background: var(--layout-bg); color: var(--layout-text); overflow: hidden; }

        <style>html { display: none; }</style>

        <script>
  (async () => {
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    if (!token) {
      document.body.innerHTML = "<h2>Acesso restrito</h2>";
      return;
    }

    try {
      const res = await fetch(`/.netlify/functions/validate-token?token=${token}`);
      const result = await res.json();

      if (!result.valid) {
        document.body.innerHTML = "<h2>Acesso expirado ou inv√°lido</h2>";
        return;
      }

      // Token v√°lido ‚Üí app continua carregando
      document.documentElement.style.display = "block";

    } catch (e) {
      document.body.innerHTML = "<h2>Erro de valida√ß√£o</h2>";
    }
  })();
</script>
        
        .glass { 
            background: #FFFFFF; 
            border: 1px solid var(--layout-border); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .glass-dark { 
            background: var(--layout-sidebar); 
            color: var(--layout-sidebar-text); 
        }
        .admin-panel {
            box-shadow: none !important;
            border-radius: 0 !important;
        }
        .card { transition: all 0.2s; border-radius: 12px; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.08); }
        .card-chart { resize: both; overflow: hidden; min-width: 300px; min-height: 350px; max-width: 100%; }
        .resize-handle { position: absolute; bottom: 4px; right: 4px; width: 14px; height: 14px; opacity: 0.25; pointer-events: none; }
        .resize-handle::before { content: '‚§°'; font-size: 14px; color: currentColor; }
        .card-chart:hover .resize-handle { opacity: 0.5; }
        .card-resizable { resize: both; overflow: hidden; min-width: 300px; min-height: 350px; max-width: 100%; position: relative; }
        .resize-indicator { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; opacity: 0.3; pointer-events: none; background: linear-gradient(135deg, transparent 50%, currentColor 50%); }
        .card-resizable:hover .resize-indicator { opacity: 0.6; }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); }
        
        .brand-header {
            height: 9rem; 
            background: #FFFFFF;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            position: relative;
            z-index: 40;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .header-section { flex: 1; display: flex; align-items: center; height: 100%; }
        .header-left { justify-content: flex-end; gap: 0; padding-right: 1rem; }
        .header-right { justify-content: flex-start; gap: 0; padding-left: 1rem; }
        
        .header-center { 
            flex: 0 0 380px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-left: 1px solid var(--layout-border); 
            border-right: 1px solid var(--layout-border); 
            height: 70%;
            padding: 0 1rem;
            gap: 0.3rem;
        }
        
        .header-center h1 {
            margin: 0;
            line-height: 1.2;
        }
        
        .header-center p {
            margin: 0.1rem 0 0 0;
            text-align: center;
            font-size: 0.65rem;
        }

        .logo-upload { 
            max-height: 8.5rem; 
            width: auto; 
            max-width: 340px; 
            object-fit: contain; 
            mix-blend-mode: multiply; 
            transition: transform 0.3s; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.08));
        }
        .logo-upload:hover { transform: scale(1.02); }

        .logo-placeholder { 
            opacity: 1 !important;
            background-color: #ffffff;
            border: 1px solid #94a3b8; 
            border-radius: 8px; 
            padding: 1.2rem 2.5rem; 
            text-align: center; 
            color: #0f172a; 
            font-weight: 700; 
            font-size: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .logo-placeholder:hover {
            background: #F5F3FF;
            border-color: var(--brand-500);
        }

        .header-center h1 { 
            font-size: 1.5rem; 
            font-weight: 900; 
            text-transform: uppercase; 
            color: #1E293B; 
            letter-spacing: -0.04em; 
            white-space: nowrap; 
            line-height: 1; 
        }
        .header-center p { 
            font-size: 0.7rem; 
            font-style: italic; 
            color: #9CA3AF; 
            margin-top: 0.2rem; 
            font-family: 'Inter', serif; 
            font-weight: 500; 
            text-align: center;
        }

        .lexops-logo-admin {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 90px;
            background: #F8FAFC;
            margin: 0;
            padding: 0.5rem;
            overflow: hidden;
            border-radius: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }

        .lexops-logo-admin::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
            display: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .lexops-logo-admin img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: none !important;
            transform: scale(2.6);
            transform-origin: center;
            opacity: 1 !important;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .lexops-logo-admin img:hover {
            transform: scale(2.7);
        }

        /* Garante que as op√ß√µes do menu dropdown sejam sempre leg√≠veis */
        select option {
            background-color: #FFFFFF !important;
            color: #1F2937 !important;
        }

        .lexops-logo-fallback {
            font-size: clamp(2.8rem, 7.5vw, 4.2rem);
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
            position: relative;
            z-index: 2;
            line-height: 1;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(203, 213, 225, 0.5); border-radius: 3px; }
        .preview-box { font-size: 10px; color: #64748b; background: #f8fafc; padding: 6px; border-radius: 6px; border: 1px dashed #e2e8f0; margin-top: 6px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .admin-section-title {
            color: var(--layout-sidebar-text);
            opacity: 0.6;
        }
        
        .admin-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--layout-sidebar-text);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .admin-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .admin-select {
            background: rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--layout-sidebar-text);
        }
        
        .admin-checkbox {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        body.client-mode .admin-panel { display: none !important; }
        body.client-mode .logo-placeholder { display: none !important; }
        body.client-mode .client-controls { display: flex !important; }
        
        #pageLoader { position: fixed; inset: 0; background: var(--layout-bg); z-index: 9999; display: none; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--brand-500); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media print {
            .no-print, .admin-panel, .client-controls, #emptyState { display: none !important; }
            main { margin: 0 !important; width: 100% !important; overflow: visible !important; }
            .glass { box-shadow: none !important; border: 1px solid #cbd5e1 !important; break-inside: avoid; }
            #dashboardBody { padding: 0 !important; }
            #dashContent { display: block !important; }
            .brand-header { border-bottom: 2px solid #000; margin-bottom: 20px; height: auto; padding: 20px 0; }
        }
    </style>
</head>
<body class="flex h-screen font-sans text-sm">

    <aside id="adminPanel" class="admin-panel w-80 glass-dark flex flex-col shrink-0 transition-all" style="z-index: 1000; position: relative;">
        <div class="lexops-logo-admin flex items-center justify-center border-b" style="border-color: var(--layout-sidebar-border);">
            <img id="lexopsHeaderLogo" src="C:\Users\User\Desktop\lexops-insight\public\assets\img\logo-lexops.png" alt="LexOps Insight" class="logo-upload">
            <input type="file" id="lexopsMainLogo" accept="image/*" class="hidden">
        </div>

        <div class="flex-1 overflow-y-auto p-5 pt-2 space-y-8" style="position: relative; z-index: 1001;">
            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-database mr-2"></i> Configura√ß√£o</h3>
                <div class="space-y-2">
                    <button onclick="document.getElementById('fileInput').click()" class="w-full py-3 rounded-lg text-xs font-bold border flex items-center justify-center gap-2 transition-all group shadow-md admin-button" style="position: relative; z-index: 1002; cursor: pointer;">
                        <i class="fas fa-file-excel text-emerald-400 text-sm group-hover:scale-110"></i> Importar Base
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">
                </div>
                <div class="grid grid-cols-2 gap-2 pt-1">
                    <button onclick="document.getElementById('logoClient').click()" class="admin-button text-[10px] py-2.5 rounded border transition-all font-medium"><i class="fas fa-building mr-1"></i> Logo Cliente</button>
                    <button onclick="document.getElementById('logoOffice').click()" class="admin-button text-[10px] py-2.5 rounded border transition-all font-medium"><i class="fas fa-briefcase mr-1"></i> Logo Escrit√≥rio</button>
                </div>
                <input type="file" id="logoOffice" accept="image/*" class="hidden">
                <input type="file" id="logoClient" accept="image/*" class="hidden">
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-paint-brush mr-2"></i> Apar√™ncia</h3>
                
                <div class="p-3 rounded-lg space-y-3 border admin-button" style="border-color: rgba(255,255,255,0.1)">
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Paleta de Gr√°ficos</label>
                        <select id="paletteSelect" onchange="updatePalette(this.value)" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="indigo">LexOps Classic (Indigo)</option>
                            <option value="ocean">Oceanic Blue (Teal)</option>
                            <option value="sunset">Executive Sunset (Orange)</option>
                            <option value="forest">Corporate Forest (Green)</option>
                            <option value="night">Night Vision (Purple)</option>
                            <option value="rose">High Alert (Red)</option>
                            <option value="gold">Golden Premium (Gold)</option>
                            <option value="slate">Corporate Slate (Gray)</option>
                            <option value="emerald">Professional Emerald (Green)</option>
                            <option value="crimson">Power Crimson (Red/Pink)</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-[10px] font-medium admin-section-title">Cor Personalizada</span>
                        <div class="h-6 w-6 rounded-full border overflow-hidden relative cursor-pointer hover:border-white" style="border-color: rgba(255,255,255,0.3)">
                            <input type="color" onchange="updateCustomColor(this.value)" class="absolute -top-2 -left-2 w-10 h-10 cursor-pointer">
                        </div>
                    </div>
                </div>

                <div class="p-3 rounded-lg space-y-3 border admin-button" style="border-color: rgba(255,255,255,0.1)">
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Tema do Layout</label>
                        <select id="layoutThemeSelect" onchange="updateLayoutTheme(this.value)" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="minimal">Minimal White</option>
                            <option value="slate">Professional Slate</option>
                            <option value="midnight">Midnight Dark</option>
                            <option value="cream">Warm Cream</option>
                            <option value="ocean">Ocean Blue</option>
                            <option value="forest">Forest Green</option>
                            <option value="lavender">Soft Lavender</option>
                            <option value="ink">Corporate Ink</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="resetLayout()" class="w-full py-2 rounded-lg text-xs font-bold border transition-all admin-button">
                    <i class="fas fa-undo mr-2"></i> Restaurar Padr√£o
                </button>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-chart-line mr-2"></i> Criar Gr√°fico Personalizado</h3>
                <div class="p-3 rounded-lg space-y-3 border admin-button" style="border-color: rgba(255,255,255,0.1)">
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Eixo X (Dimens√£o)</label>
                        <select id="biX" class="w-full border text-xs rounded p-2 outline-none admin-select"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Eixo Y (M√©trica)</label>
                        <select id="biY" onchange="toggleYCol()" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="count">Contagem (Quantidade de Processos)</option>
                            <option value="sum">Soma (Valor Total)</option>
                            <option value="avg">M√©dia (Valor M√©dio)</option>
                        </select>
                    </div>
                    <div id="biYColDiv" class="space-y-1 hidden">
                        <label class="text-[10px] block font-medium admin-section-title">Coluna de Dados (Eixo Y)</label>
                        <select id="biYCol" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="">Selecione a coluna...</option>
                        </select>
                        <p class="text-[9px] opacity-60 mt-1 admin-section-title">üí° Todas as colunas da planilha dispon√≠veis</p>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">Tipo de Gr√°fico</label>
                        <select id="biType" class="w-full border text-xs rounded p-2 outline-none admin-select">
                            <option value="bar">Barras Vertical</option>
                            <option value="bar_h">Barras Horizontal</option>
                            <option value="line">Linha</option>
                            <option value="doughnut">Rosca (Doughnut)</option>
                            <option value="pie">Pizza (Pie)</option>
                            <option value="polarArea">√Årea Polar</option>
                            <option value="radar">Radar</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] block font-medium admin-section-title">T√≠tulo do Gr√°fico</label>
                        <input type="text" id="biTitle" placeholder="Ex: An√°lise de Valores por √Årea" class="w-full border text-xs rounded p-2 outline-none admin-select">
                    </div>
                    <button onclick="addChart()" class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-lg transition-all" style="background: var(--brand-500); color: white;">
                        <i class="fas fa-plus-circle"></i> Adicionar Gr√°fico
                    </button>
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] font-bold uppercase tracking-widest border-b pb-2 admin-section-title" style="border-color: var(--layout-sidebar-border)"><i class="fas fa-filter mr-2"></i> Filtros de Dados</h3>
                <div id="filtersContainer" class="space-y-4 max-h-60 overflow-y-auto pr-1"></div>
            </section>
        </div>

        <div class="p-4 border-t space-y-2" style="background: var(--layout-sidebar); border-color: var(--layout-sidebar-border)">
            <button onclick="window.print()" class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-md admin-button">
                <i class="fas fa-print"></i> PDF
            </button>
            <button onclick="exportConsolidatedHTML()" class="w-full py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-lg transition-all" style="background: #10b981; color: white;">
                <i class="fas fa-share-alt"></i> Exportar HTML
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative">
        <header class="brand-header shrink-0 shadow-sm">
            
            <div class="header-section header-left">
                <div id="phOffice" class="logo-placeholder" onclick="document.getElementById('logoOffice').click()">Logo Escrit√≥rio</div>
                <img id="imgOffice" src="" class="logo-upload hidden" alt="Logo Escrit√≥rio">
            </div>

            <div class="header-center">
                <div id="lexopsHeaderFallback" style="display: block;">
                    <h1>An√°lise Jur√≠dica Corporativa</h1>
                </div>
                <p style="font-size: 0.65rem; margin-top: 0.3rem;">powered by <span class="font-bold not-italic">LexOpsInsight</span></p>
            </div>

            <div class="header-section header-right">
                <img id="imgClient" src="" class="logo-upload hidden" alt="Logo Cliente">
                <div id="phClient" class="logo-placeholder" onclick="document.getElementById('logoClient').click()">Logo Cliente</div>
            </div>
        </header>

        <div id="clientControls" class="client-controls hidden px-8 py-3 border-b items-center gap-4 z-30 shadow-sm no-print" style="background: var(--layout-card); border-color: var(--layout-border)">
            <div class="relative shrink-0">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input type="text" id="globalSearch" placeholder="Pesquisar em tudo..." class="pl-9 pr-4 py-2.5 rounded-lg text-xs w-64 focus:ring-2 focus:ring-brand-500 outline-none transition-all font-medium placeholder:text-slate-400" style="background: var(--layout-accent); border: 1px solid var(--layout-border); color: var(--layout-text)" onkeyup="renderAll()">
            </div>
            <div class="h-6 w-px mx-2" style="background: var(--layout-border)"></div>
            <div id="clientFilters" class="flex gap-2 flex-wrap flex-1 items-center pb-1"></div>
            <button onclick="resetFilters()" class="text-xs text-rose-500 hover:text-rose-700 font-bold hover:underline whitespace-nowrap ml-2">
                <i class="fas fa-undo mr-1"></i> Limpar Filtros
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-8" id="dashboardBody" style="background: var(--layout-bg)">
            <div id="abcAlert" class="hidden mb-6 p-5 rounded-xl border-l-4 shadow-md relative" style="background: linear-gradient(to right, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.02)); border-color: #f59e0b;">
                <button onclick="document.getElementById('abcAlert').classList.add('hidden')" class="absolute top-3 right-3 text-amber-600 hover:text-amber-800 transition-colors" title="Fechar">
                    <i class="fas fa-times text-lg"></i>
                </button>
                <div class="flex items-start gap-4">
                    <div class="text-3xl">‚ö†Ô∏è</div>
                    <div class="flex-1">
                        <h3 class="font-black text-sm mb-2" contenteditable="true" style="color: #92400e; outline: none; cursor: text;" title="Clique para editar">An√°lise de Concentra√ß√£o de Impacto</h3>
                        <div id="abcMessage" class="text-xs" contenteditable="true" style="color: #78350f; outline: none; cursor: text;" title="Clique para editar"></div>
                    </div>
                </div>
            </div>
            <div id="emptyState" class="h-full flex flex-col items-center justify-center opacity-50">
                <div class="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-file-contract text-4xl text-slate-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-600">Dashboard Pronto</h3>
                <p class="text-slate-400 mt-2 text-sm">Carregue sua base de processos para come√ßar.</p>
            </div>

            <div id="dashContent" class="hidden space-y-8 pb-10">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 break-inside-avoid">
                    <div class="glass p-6 rounded-2xl border-t-4 border-slate-400 card relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 text-slate-100 group-hover:text-slate-200 transition-colors"><i class="fas fa-folder text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold uppercase tracking-wider mb-1 relative z-10" style="color: #6B7280">Volume Total</p>
                        <h3 class="text-4xl font-black relative z-10" style="color: var(--layout-text)" id="kTotal">0</h3>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 card relative overflow-hidden group" style="border-color: var(--brand-500)">
                        <div class="absolute right-0 top-0 p-4 text-slate-100 group-hover:text-slate-200 transition-colors"><i class="fas fa-coins text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold uppercase tracking-wider mb-1 relative z-10" style="color: #6B7280">Exposi√ß√£o Total</p>
                        <h3 class="text-4xl font-black text-brand-600 relative z-10" style="color: var(--brand-600)" id="kTotalVal">R$ 0</h3>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 border-rose-500 card relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 text-rose-100 group-hover:text-rose-200 transition-colors"><i class="fas fa-fire text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold text-rose-500 uppercase tracking-wider mb-1 relative z-10">Risco Prov√°vel</p>
                        <h3 class="text-4xl font-black relative z-10" style="color: var(--layout-text)" id="kRiskProv">R$ 0</h3>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 card relative overflow-hidden group" style="border-color: var(--brand-500)">
                        <div class="absolute right-0 top-0 p-4 text-slate-100 group-hover:text-slate-200 transition-colors"><i class="fas fa-calculator text-6xl opacity-20 transform rotate-12"></i></div>
                        <p class="text-[10px] font-bold uppercase tracking-wider mb-1 relative z-10" style="color: #6B7280">Ticket M√©dio</p>
                        <h3 class="text-4xl font-black relative z-10" style="color: var(--layout-text)" id="kAvg">R$ 0</h3>
                    </div>
                </div>

                <div id="chartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>

                <div class="glass rounded-2xl overflow-hidden shadow-sm border break-before-page" style="border-color: var(--layout-border)">
                    <div class="px-6 py-5 border-b flex justify-between items-center" style="border-color: var(--layout-border); background: var(--layout-accent)">
                        <h4 class="font-bold text-xs uppercase tracking-wide flex items-center gap-2" style="color: var(--layout-text)">
                            <i class="fas fa-table text-slate-400"></i> Detalhamento
                        </h4>
                        <span class="border px-3 py-1 rounded-full text-[10px] font-bold text-slate-500 shadow-sm" style="background: var(--layout-card); border-color: var(--layout-border)" id="tableCount">0</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b text-[9px] uppercase font-black text-slate-500 tracking-wider" style="background: var(--layout-accent); border-color: var(--layout-border)">
                                <tr>
                                    <th class="px-6 py-4">Processo (CNJ)</th>
                                    <th class="px-6 py-4">Partes</th>
                                    <th class="px-6 py-4">Pedidos / Objetos</th>
                                    <th class="px-6 py-4">Filial</th>
                                    <th class="px-6 py-4 text-right">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable" class="divide-y text-xs" style="--tw-divide-opacity: 1; divide-color: var(--layout-border); color: var(--layout-text)"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="mapModal" class="fixed inset-0 z-[70] hidden items-center justify-center p-6 modal-overlay">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white">
                <div><h3 class="font-bold text-lg text-slate-800">Mapeamento de Dados</h3><p class="text-xs text-slate-500 mt-1">Vincule as colunas da planilha.</p></div>
                <div class="w-10 h-10 rounded-full bg-brand-50 flex items-center justify-center text-brand-600" style="background-color: #eef2ff"><i class="fas fa-sitemap"></i></div>
            </div>
            <div id="mapBody" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto bg-slate-50/30"></div>
            <div class="px-8 py-5 border-t border-slate-100 flex justify-end gap-3 bg-white">
                <button onclick="processData()" class="bg-brand-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all text-sm flex items-center gap-2" style="background-color: var(--brand-600)"><i class="fas fa-rocket"></i> Confirmar</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4 modal-overlay" onclick="closeDetail()">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0">
                <h3 class="font-bold text-slate-800 flex items-center gap-3 text-lg"><span id="detTitle">Ficha do Processo</span></h3>
                <button onclick="closeDetail()" class="text-slate-400 hover:text-rose-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="detBody" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-12 overflow-y-auto text-slate-700"></div>
        </div>
    </div>

    <script>
        const LEXOPS_LOGO_URL = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 90'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235b21b6;stop-opacity:1'/%3E%3Cstop offset='50%25' style='stop-color:%237c3aed;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23a855f7;stop-opacity:1'/%3E%3C/linearGradient%3E%3Cfilter id='shadow'%3E%3CfeDropShadow dx='0' dy='4' stdDeviation='8' flood-opacity='0.4'/%3E%3C/filter%3E%3C/defs%3E%3Crect width='320' height='90' fill='url(%23g1)' rx='12'/%3E%3Cg filter='url(%23shadow)'%3E%3Ctext x='160' y='48' font-family='Inter,Arial,sans-serif' font-size='38' font-weight='900' fill='white' text-anchor='middle' letter-spacing='3'%3ELexOps%3C/text%3E%3Ctext x='160' y='72' font-family='Inter,Arial,sans-serif' font-size='13' font-weight='700' fill='rgba(255,255,255,0.85)' text-anchor='middle' letter-spacing='5'%3EINSIGHT%3C/text%3E%3C/g%3E%3C/svg%3E";

        var dStore = []; 
        var customCharts = [];
        var colMapping = {};
        var filterState = {}; 
        var activeChartFilters = {};
        var logoData = { office: null, client: null, lexops: LEXOPS_LOGO_URL };
        var themeConfig = { brand: '#4f46e5', paletteName: 'indigo', palette: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'] };
        var layoutTheme = 'minimal';
        var chartInstances = {};
        var rawHeaders = [];
        var numericColumns = [];
        var mappedValueColumn = null;

        const PALETTES = {
            indigo: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'],
            ocean: ['#0891b2', '#06b6d4', '#22d3ee', '#67e8f9', '#a5f3fc'],
            sunset: ['#ea580c', '#f97316', '#fb923c', '#fdba74', '#fed7aa'],
            forest: ['#0f766e', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4'],
            night: ['#3b0764', '#581c87', '#7e22ce', '#a855f7', '#d8b4fe'],
            rose: ['#be123c', '#e11d48', '#f43f5e', '#fb7185', '#fda4af'],
            gold: ['#92400e', '#b45309', '#d97706', '#f59e0b', '#fbbf24'],
            slate: ['#334155', '#475569', '#64748b', '#94a3b8', '#cbd5e1'],
            emerald: ['#047857', '#059669', '#10b981', '#34d399', '#6ee7b7'],
            crimson: ['#881337', '#9f1239', '#be123c', '#e11d48', '#f43f5e']
        };

        const LAYOUT_THEMES = {
            minimal: { bg: '#F9FAFB', card: '#ffffff', text: '#111827', border: '#E5E7EB', accent: '#F3F4F6', sidebar: '#0f172a', sidebarText: '#f8fafc', sidebarBorder: '#1e293b' },
            slate: { bg: '#F1F5F9', card: '#ffffff', text: '#0F172A', border: '#CBD5E1', accent: '#E2E8F0', sidebar: '#334155', sidebarText: '#f1f5f9', sidebarBorder: '#475569' },
            midnight: { bg: '#0F172A', card: '#1E293B', text: '#F1F5F9', border: '#334155', accent: '#1E293B', sidebar: '#020617', sidebarText: '#e2e8f0', sidebarBorder: '#0f172a' },
            cream: { bg: '#FEF3E2', card: '#FFFFFF', text: '#451a03', border: '#F3D5A7', accent: '#FDF8F0', sidebar: '#92400e', sidebarText: '#fef3e2', sidebarBorder: '#b45309' },
            ocean: { bg: '#E0F2FE', card: '#FFFFFF', text: '#0C4A6E', border: '#7DD3FC', accent: '#F0F9FF', sidebar: '#0369a1', sidebarText: '#e0f2fe', sidebarBorder: '#0284c7' },
            forest: { bg: '#DCFCE7', card: '#FFFFFF', text: '#14532D', border: '#86EFAC', accent: '#F0FDF4', sidebar: '#15803d', sidebarText: '#dcfce7', sidebarBorder: '#16a34a' },
            lavender: { bg: '#F3E8FF', card: '#FFFFFF', text: '#581C87', border: '#D8B4FE', accent: '#FAF5FF', sidebar: '#7e22ce', sidebarText: '#f3e8ff', sidebarBorder: '#9333ea' },
            ink: { bg: '#DBEAFE', card: '#FFFFFF', text: '#1E3A8A', border: '#93C5FD', accent: '#EFF6FF', sidebar: '#1e40af', sidebarText: '#dbeafe', sidebarBorder: '#2563eb' }
        };

        const FIELDS = {
            Numero: ['cnj', 'processo', 'nro', 'numero', 'pasta', 'judicial', 'id', 'refer√™ncia', 'referencia', 'n√∫mero'],
            Cliente: ['cliente', 'empresa', 'polo ativo', 'requerente', 'autor'],
            Filial: ['filial', 'unidade', 'site', 'centro de custo', 'centro', 'custo', 'divis√£o', 'divisao', 'regional'],
            Parte: ['adverso', 'reclamante', 'reu', 'r√©u', 'contraria', 'contr√°ria', 'polo passivo', 'reclamado', 'requerido'],
            Valor: ['valor', 'causa', 'principal', 'risco', 'montante', 'condena√ß√£o', 'condenacao', 'conting√™ncia', 'contingencia', 'atualizado', 'pedido', 'provisionamento', 'provis√£o', 'provisao'],
            Area: ['area', '√°rea', 'ramo', 'natureza', 'assunto', 'classe', 'mat√©ria', 'materia', 'especialidade'],
            Risco: ['risco', 'prognostico', 'progn√≥stico', 'probabilidade', 'perda', 'parecer', 'classifica√ß√£o', 'classificacao'],
            Objeto: ['objeto', 'pedido', 'pleitos', 'assunto', 'descri√ß√£o', 'descricao', 'causa de pedir', 'tese'],
            // Optional fields (multiple values support)
            Condena√ß√£o: ['condena√ß√£o', 'condenacao', 'condenado', 'senten√ßa', 'sentenca', 'julgado'],
            Acordo: ['acordo', 'acor√ßado', 'transa√ß√£o', 'transacao', 'concilia√ß√£o', 'conciliacao', 'media√ß√£o', 'mediacao'],
            Provis√£o: ['provis√£o', 'provisao', 'reserva', 'estimativa', 'previs√£o', 'previsao', 'expectativa']
        };

        function b64DecodeUnicode(str) {
            try {
                return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) { console.error("Erro decode:", e); return "[]"; }
        }

        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                return String.fromCharCode('0x' + p1);
            }));
        }

        function isNumericColumn(data, colName) {
            const sample = data.slice(0, Math.min(50, data.length));
            let numericCount = 0;
            for (let row of sample) {
                const val = row[colName];
                if (val !== null && val !== undefined && val !== '') {
                    const parsed = parseVal(val);
                    if (!isNaN(parsed) && parsed !== 0) numericCount++;
                }
            }
            return numericCount > sample.length * 0.3;
        }

        function formatValue(val, colName) {
            const lowerCol = (colName || '').toLowerCase();
            if (lowerCol.includes('valor') || lowerCol.includes('montante') || lowerCol.includes('causa')) {
                return fmtMoney(val);
            }
            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return (val / 1000).toFixed(1) + 'K';
            return val.toFixed(0);
        }

        function parseVal(v) {
            if(!v) return 0;
            if(typeof v==='number') return v;
            const s = String(v).replace(/[R$\s]/g,'');
            if(s.includes(',') && s.lastIndexOf(',') > s.lastIndexOf('.')) return parseFloat(s.replace(/\./g,'').replace(',','.'))||0;
            return parseFloat(s.replace(/,/g,''))||0;
        }

        function fmtMoney(v) { return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

        // Initialize immediately when scripts load
        (function() {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
            
            function initializeApp() {
                console.log('Initializing app...');
                
                // File input for data import
                const fileInput = document.getElementById('fileInput');
                console.log('fileInput found:', !!fileInput);
                if(fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        console.log('File selected:', e.target.files[0]);
                        const f = e.target.files[0];
                        if(!f) return;
                        const r = new FileReader();
                        r.onload = function(ev) {
                            try {
                                const wb = XLSX.read(ev.target.result, {type:'array'});
                                const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                if(!raw || raw.length===0) throw new Error("Vazio");
                                rawHeaders = Object.keys(raw[0]);
                                window._tempRaw = raw;
                                showMapping();
                            } catch(err) { 
                                alert("Erro na leitura do arquivo: " + err.message); 
                                console.error(err);
                            }
                        };
                        r.readAsArrayBuffer(f);
                    });
                }

                // Logo uploads
                ['logoOffice', 'logoClient', 'lexopsMainLogo'].forEach(function(id) {
                    const el = document.getElementById(id);
                    console.log(id + ' found:', !!el);
                    if(el) {
                        el.addEventListener('change', function(e) {
                            console.log('Logo file selected for ' + id);
                            const r = new FileReader();
                            r.onload = function(ev) { 
                                if(id.includes('Office')) logoData.office = ev.target.result; 
                                else if(id.includes('Client')) logoData.client = ev.target.result;
                                else if(id.includes('Main')) logoData.lexops = ev.target.result;
                                applyLogos(); 
                            };
                            if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
                        });
                    }
                });

                console.log('Event listeners registered');
            }
        })();

        window.onload = function() {
            setTimeout(() => {
                applyLexOpsLogo();

                const dataIsland = document.getElementById('consolidated-data');
                if (dataIsland && dataIsland.textContent.trim().length > 0) {
                    try {
                        const rawJson = JSON.parse(dataIsland.textContent);
                        window.dStore = JSON.parse(b64DecodeUnicode(rawJson.dStore));
                        window.customCharts = JSON.parse(b64DecodeUnicode(rawJson.customCharts));
                        window.themeConfig = JSON.parse(b64DecodeUnicode(rawJson.themeConfig));
                        window.colMapping = JSON.parse(b64DecodeUnicode(rawJson.colMapping));
                        window.logoData = JSON.parse(b64DecodeUnicode(rawJson.logoData));
                        
                        if(rawJson.layoutTheme) window.layoutTheme = rawJson.layoutTheme;
                        if(rawJson.numericColumns) window.numericColumns = rawJson.numericColumns;
                        if(rawJson.mappedValueColumn) window.mappedValueColumn = rawJson.mappedValueColumn;
                        
                        document.body.classList.add('client-mode');
                        const adminPanel = document.getElementById('adminPanel');
                        if(adminPanel) adminPanel.remove();
                        
                        document.getElementById('dataTable').innerHTML = '';
                        document.getElementById('chartsGrid').innerHTML = '';
                        
                        applyTheme(); 
                        applyLayoutTheme();
                        applyLogos();
                        applyLexOpsLogo();
                        
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('dashContent').classList.remove('hidden');
                        
                        populateChartBuilder();
                        initFiltersUI(); 
                        renderAll(); 
                    } catch (err) {
                        alert("Erro cr√≠tico nos dados.");
                        console.error(err);
                    }
                }
            }, 300);
        };

        function applyLexOpsLogo() {
            const img = document.getElementById('lexopsLogoImg');
            const fallback = document.getElementById('lexopsLogoFallback');
            
            if(!img) return;
            
            // Always show the logo from the file system
            img.style.display = 'block';
            img.src = 'C:\\Users\\User\\Desktop\\lexops-insight\\public\\assets\\img\\logo-lexops.png';
            
            if(fallback) fallback.style.display = 'none';
            
            // If upload provides custom logo, use it
            if(logoData && logoData.lexops) {
                img.src = logoData.lexops;
                img.onload = function() { 
                    this.style.display = 'block';
                    if(fallback) fallback.style.display = 'none';
                };
                img.onerror = function() {
                    this.src = 'C:\\Users\\User\\Desktop\\lexops-insight\\public\\assets\\img\\logo-lexops.png';
                };
            }
        }

        ['logoOffice', 'logoClient', 'lexopsMainLogo'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('change', e => {
                    const r = new FileReader();
                    r.onload = ev => { 
                        if(id.includes('Office')) logoData.office = ev.target.result; 
                        else if(id.includes('Client')) logoData.client = ev.target.result;
                        else if(id.includes('Main')) logoData.lexops = ev.target.result;
                        applyLogos(); 
                    };
                    if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
                });
            }
        });

        function applyLogos() {
            if(logoData.office) { 
                const img = document.getElementById('imgOffice'); 
                if(img) { 
                    img.src = logoData.office; 
                    img.classList.remove('hidden'); 
                    document.getElementById('phOffice').classList.add('hidden'); 
                }
            }
            if(logoData.client) { 
                const img = document.getElementById('imgClient'); 
                if(img) { 
                    img.src = logoData.client; 
                    img.classList.remove('hidden'); 
                    document.getElementById('phClient').classList.add('hidden'); 
                }
            }
            if(logoData.lexops) {
                const imgAdmin = document.getElementById('lexopsLogoImg');
                const imgHeader = document.getElementById('lexopsHeaderLogo');
                if(imgAdmin) {
                    imgAdmin.src = logoData.lexops;
                    imgAdmin.classList.remove('hidden');
                    document.getElementById('lexopsLogoFallback').classList.add('hidden');
                }
                if(imgHeader) {
                    imgHeader.src = logoData.lexops;
                    imgHeader.classList.remove('hidden');
                    document.getElementById('lexopsHeaderFallback').classList.add('hidden');
                }
            }
        }

        function showMapping() {
            const body = document.getElementById('mapBody'); 
            body.innerHTML = '';
            body.className = 'p-8 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto bg-slate-50';
            
            // All fields (no more mandatory/optional distinction for UX)
            const allFields = ['Numero', 'Cliente', 'Filial', 'Parte', 'Valor', 'Area', 'Risco', 'Objeto', 'Condena√ß√£o', 'Acordo', 'Provis√£o'];
            
            // Default display names
            if(!window.displayLabels) {
                window.displayLabels = {
                    'Numero': 'N√∫mero do Processo',
                    'Cliente': 'Cliente',
                    'Filial': 'Filial',
                    'Parte': 'Parte Adversa',
                    'Valor': 'Valor da Causa',
                    'Area': '√Årea do Direito',
                    'Risco': 'Classifica√ß√£o de Risco',
                    'Objeto': 'Objeto/Pedidos',
                    'Condena√ß√£o': 'Valor de Condena√ß√£o',
                    'Acordo': 'Valor de Acordo',
                    'Provis√£o': 'Provis√£o Cont√°bil'
                };
            }
            
            allFields.forEach(f => {
                let best = '';
                for(let header of rawHeaders) {
                    const headerLower = header.toLowerCase();
                    const fieldSynonyms = FIELDS[f] || [f.toLowerCase()];
                    for(let synonym of fieldSynonyms) {
                        if(headerLower.includes(synonym.toLowerCase())) {
                            best = header;
                            break;
                        }
                    }
                    if(best) break;
                }

                const cardHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-5 hover:shadow-md transition-all group">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 flex items-center gap-2">
                                <input type="text" 
                                       id="label_${f}" 
                                       value="${window.displayLabels[f]}" 
                                       class="flex-1 text-sm font-bold text-slate-700 bg-transparent border-0 outline-none px-2 py-1 rounded hover:bg-slate-50 focus:bg-white focus:border focus:border-slate-300 transition-all"
                                       placeholder="Nome do campo...">
                                <i class="fas fa-pencil text-slate-300 group-hover:text-brand-500 text-xs transition-colors"></i>
                            </div>
                            <span id="badge_${f}" class="text-[9px] px-2 py-1 rounded-full font-bold bg-slate-100 text-slate-500">Opcional</span>
                        </div>
                        <select id="map_${f}" 
                                onchange="updateMappingStatus('${f}', this.value)" 
                                class="w-full border border-slate-200 p-2.5 rounded-lg text-xs focus:ring-2 focus:ring-brand-500 bg-white outline-none transition-all">
                            <option value="">(N√£o Mapear)</option>
                            ${rawHeaders.map(h => `<option value="${h}" ${h===best?'selected':''}>${h}</option>`).join('')}
                        </select>
                        <div id="prev_${f}" class="mt-3 text-[10px] text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 h-16 overflow-y-auto"></div>
                        <div class="mt-2 flex items-center gap-2">
                            <input type="checkbox" id="filter_${f}" class="w-3 h-3 cursor-pointer accent-brand-500">
                            <label for="filter_${f}" class="text-[9px] cursor-pointer text-slate-600">üìä Disponibilizar como filtro lateral</label>
                        </div>
                    </div>
                `;
                
                body.innerHTML += cardHTML;
                setTimeout(() => updateMappingStatus(f, best), 50);
            });
            
            document.getElementById('mapModal').classList.replace('hidden', 'flex');
        }

        function updateMappingStatus(field, columnValue) {
            const badge = document.getElementById(`badge_${field}`);
            const preview = document.getElementById(`prev_${field}`);
            
            if(!columnValue) { 
                badge.className = 'text-[9px] px-2 py-1 rounded-full font-bold bg-slate-100 text-slate-500';
                badge.textContent = 'Opcional';
                preview.innerHTML = '<div class="text-slate-400 italic">N√£o mapeado</div>'; 
                return; 
            }
            
            // Update badge to "Mapped"
            badge.className = 'text-[9px] px-2 py-1 rounded-full font-bold bg-emerald-100 text-emerald-700';
            badge.textContent = 'Mapeado';
            
            // Update preview
            const vals = window._tempRaw.slice(0,3).map(r=>r[columnValue]);
            preview.innerHTML = vals.map(v=>`<div class="text-brand-600 font-semibold text-[9px] mb-1">‚Ä¢ ${v||'(vazio)'}</div>`).join('');
        }

        function processData() {
            // Save custom labels
            const allFields = ['Numero', 'Cliente', 'Filial', 'Parte', 'Valor', 'Area', 'Risco', 'Objeto', 'Condena√ß√£o', 'Acordo', 'Provis√£o'];
            allFields.forEach(f => {
                const labelInput = document.getElementById(`label_${f}`);
                if(labelInput) {
                    window.displayLabels[f] = labelInput.value || f;
                }
            });
            
            const maps = {};
            Object.keys(FIELDS).forEach(f => {
                const elem = document.getElementById(`map_${f}`);
                maps[f] = elem ? elem.value : '';
            });
            
            colMapping = maps;
            mappedValueColumn = maps.Valor;
            numericColumns = rawHeaders.filter(h => isNumericColumn(window._tempRaw, h));

            // Removed mandatory validation - all fields are optional now
            let emptyVals = 0;
            const limit = Math.min(window._tempRaw.length, 100);
            for(let i=0; i<limit; i++) if(!window._tempRaw[i][maps.Valor]) emptyVals++;
            if(emptyVals > limit*0.5) if(!confirm("Aten√ß√£o: Mais de 50% dos registros n√£o possuem valor financeiro. Continuar?")) return;

            // ANTI-DUPLICITY: Deduplication by ID (N√∫mero/Processo)
            // If ID repeats: DON'T count new process. SUM financial values. CONCATENATE objects.
            const dedupeMap = new Map();
            
            // Collect optional fields from Smart Mapper checkboxes
            const optionalFields = {};
            ['Condena√ß√£o', 'Acordo', 'Provis√£o'].forEach(f => {
                const checkbox = document.getElementById(`filter_${f}`);
                if(checkbox && checkbox.checked) {
                    optionalFields[f] = maps[f] || null;
                }
            });
            window._filterableFields = optionalFields;

            window._tempRaw.forEach(r => {
                const numId = String(r[maps.Numero] || '').trim();
                if(!numId || numId === 'N/D') return;

                const objRaw = r[maps.Objeto];
                let objList = ['N/D'];
                if(objRaw) {
                    const str = String(objRaw);
                    // SPLITTER: Detect separators (;, /, |) as independent tags
                    objList = str.split(/[\n;|/]+/).map(s=>s.trim().replace(/^[-‚Ä¢]\s*/,'')).filter(s=>s.length>2);
                    if(objList.length===0) objList = [str.trim()];
                }
                const filial = r[maps.Filial] || 'Matriz';

                if(dedupeMap.has(numId)) {
                    // DUPLICATE FOUND: Aggregate values + concatenate objects
                    const existing = dedupeMap.get(numId);
                    existing.Valor += parseVal(r[maps.Valor]);
                    existing._duplicateCount = (existing._duplicateCount || 1) + 1;
                    
                    // Concatenate unique objects
                    objList.forEach(obj => {
                        if(!existing._objectsList.includes(obj)) {
                            existing._objectsList.push(obj);
                        }
                    });
                    
                    // Aggregate optional field values
                    Object.keys(optionalFields).forEach(f => {
                        const val = r[maps[f]];
                        if(val) {
                            if(!existing[f]) existing[f] = [];
                            if(!Array.isArray(existing[f])) existing[f] = [existing[f]];
                            existing[f].push(val);
                        }
                    });
                } else {
                    // NEW RECORD: Create entry
                    const newRecord = {
                        Numero: numId,
                        Cliente: r[maps.Cliente] || 'Geral',
                        Filial: filial,
                        Parte: r[maps.Parte] || 'N/D',
                        Valor: parseVal(r[maps.Valor]),
                        Area: r[maps.Area] || 'C√≠vel',
                        Risco: r[maps.Risco] || 'Poss√≠vel',
                        Objeto: objRaw || 'N/D',
                        _objectsList: objList,
                        _duplicateCount: 1,
                        _searchText: Object.values(r).join(' ').toLowerCase(),
                        _allData: r 
                    };
                    
                    // Initialize optional fields
                    Object.keys(optionalFields).forEach(f => {
                        const val = r[maps[f]];
                        if(val) {
                            newRecord[f] = [val];
                        }
                    });
                    
                    dedupeMap.set(numId, newRecord);
                }
            });

            // Convert Map to Array (deduplication complete)
            dStore = Array.from(dedupeMap.values());

            const uniqueAreas = [...new Set(dStore.map(d=>d.Area))];
            const uniqueRiscos = [...new Set(dStore.map(d=>d.Risco))];
            const uniqueFiliais = [...new Set(dStore.map(d=>d.Filial))];

            customCharts = [];
            
            if(uniqueAreas.length > 1) {
                customCharts.push({ id: 'c1', x: 'Area', y: 'sum', yCol: mappedValueColumn, type: 'bar_h', title: 'Exposi√ß√£o Financeira por √Årea' });
            }

            if(uniqueRiscos.length > 1) {
                customCharts.push({ id: 'c2', x: 'Risco', y: 'count', yCol: null, type: 'line', title: 'Volume de Processos por Risco' });
            } else if(uniqueFiliais.length > 1) {
                customCharts.push({ id: 'c2', x: 'Filial', y: 'count', yCol: null, type: 'line', title: 'Volume por Filial' });
            }

            if(uniqueRiscos.length > 1) {
                customCharts.push({ id: 'c3', x: 'Risco', y: 'sum', yCol: mappedValueColumn, type: 'doughnut', title: 'Distribui√ß√£o de Valores por Risco' });
            }

            if(uniqueFiliais.length > 1) {
                customCharts.push({ id: 'c4', x: 'Filial', y: 'sum', yCol: mappedValueColumn, type: 'bar', title: 'An√°lise Financeira de Filiais' });
            }

            if(customCharts.length < 2) {
                if(customCharts.length === 0) {
                    customCharts.push({ id: 'c1', x: 'Area', y: 'sum', yCol: mappedValueColumn, type: 'bar_h', title: 'Exposi√ß√£o Financeira' });
                }
                customCharts.push({ id: 'c2', x: 'Risco', y: 'count', yCol: null, type: 'line', title: 'Volume de Processos' });
            }

            document.getElementById('mapModal').classList.replace('flex', 'hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashContent').classList.remove('hidden');
            
            populateChartBuilder();
            initFiltersUI();
            renderAll();
        }

        function populateChartBuilder() {
            const biX = document.getElementById('biX');
            const biYCol = document.getElementById('biYCol');
            
            if(!biX || !biYCol) return;

            const categoricalCols = ['Area', 'Risco', 'Filial', 'Cliente', 'Parte', 'Objeto'];
            biX.innerHTML = categoricalCols.map(col => `<option value="${col}">${col}</option>`).join('');
            
            if(rawHeaders.length > 0) {
                rawHeaders.forEach(h => {
                    if(!categoricalCols.includes(h)) {
                        biX.innerHTML += `<option value="${h}">${h}</option>`;
                    }
                });
            }

            // Y-axis: Include ALL columns from rawHeaders (not just numeric)
            biYCol.innerHTML = '';
            if(rawHeaders && rawHeaders.length > 0) {
                rawHeaders.forEach(col => {
                    const selected = col === mappedValueColumn ? 'selected' : '';
                    biYCol.innerHTML += `<option value="${col}" ${selected}>${col}</option>`;
                });
            } else if(mappedValueColumn) {
                biYCol.innerHTML = `<option value="${mappedValueColumn}" selected>${mappedValueColumn}</option>`;
            } else {
                biYCol.innerHTML = '<option value="Valor">Valor</option>';
            }
        }

        function initFiltersUI() {
            const ca = document.getElementById('filtersContainer');
            const cc = document.getElementById('clientFilters'); 
            
            if(ca) ca.innerHTML = '';
            if(cc) cc.innerHTML = '';

            if(!dStore || dStore.length === 0) return;

            document.addEventListener('click', function(e) {
                if(!e.target.closest('.filter-group-btn')) {
                    document.querySelectorAll('.filter-dropdown').forEach(el => el.classList.add('hidden'));
                }
            });

            // Include both standard filters AND optional fields selected by user
            const standardDims = ['Cliente','Filial','Area','Risco','Objeto'];
            const optionalDims = window._filterableFields ? Object.keys(window._filterableFields).filter(f => window._filterableFields[f]) : [];
            const allDims = [...standardDims, ...optionalDims];

            allDims.forEach(dim => {
                let vals = [];
                if(dim==='Objeto') vals = [...new Set(dStore.flatMap(d=>d._objectsList))].sort();
                else if(optionalDims.includes(dim)) {
                    // For optional fields, extract from arrays
                    vals = [...new Set(dStore.flatMap(d => {
                        const val = d[dim];
                        return Array.isArray(val) ? val : (val ? [val] : []);
                    }))].sort();
                } else {
                    vals = [...new Set(dStore.map(d=>d[dim]))].sort();
                }

                if(vals.length > 0) {
                    if(ca) {
                        let htmlA = `<div class="mb-5 border-b pb-3" style="border-color: var(--layout-sidebar-border)"><p class="text-[9px] font-black uppercase mb-2 flex justify-between admin-section-title">${dim} <span class="px-1.5 rounded-full" style="background: rgba(0,0,0,0.2); color: var(--layout-sidebar-text)">${vals.length}</span></p>`;
                        vals.forEach(v => {
                            const b64Val = b64EncodeUnicode(v);
                            const safeID = `chk_adm_${dim}_${b64Val.replace(/[^a-zA-Z0-9]/g,'')}`;
                            htmlA += `<label class="flex items-center gap-2 mb-1.5 cursor-pointer hover:bg-white/10 p-1 rounded transition-colors"><input type="checkbox" id="${safeID}" onchange="toggleF('${dim}', '${b64Val}')" class="rounded admin-checkbox focus:ring-0 w-3.5 h-3.5" style="color: var(--brand-500)"><span class="text-xs truncate admin-section-title" title="${v}">${v}</span></label>`;
                        });
                        ca.innerHTML += htmlA + `</div>`;
                    }
                    
                    if(cc) {
                        let htmlC = `
                        <div class="relative filter-group-btn">
                            <button onclick="toggleDropdown('dd_${dim}')" class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold hover:border-brand-500 transition-all shadow-sm" style="background: var(--layout-accent); border: 1px solid var(--layout-border); color: var(--layout-text)">
                                ${dim} <i class="fas fa-chevron-down text-[9px] text-slate-400"></i>
                            </button>
                            <div id="dd_${dim}" class="filter-dropdown absolute top-full left-0 mt-2 w-64 rounded-xl shadow-xl border hidden max-h-80 overflow-y-auto p-2 z-50" style="background: var(--layout-card); border-color: var(--layout-border)">`;
                        
                        vals.forEach(v => {
                            const b64Val = b64EncodeUnicode(v);
                            const safeID = `chk_cli_${dim}_${b64Val.replace(/[^a-zA-Z0-9]/g,'')}`;
                            htmlC += `<label class="flex items-center gap-2 p-2 cursor-pointer rounded-lg transition-colors hover:bg-opacity-10" style="hover:background: var(--layout-accent)"><input type="checkbox" id="${safeID}" onchange="toggleF('${dim}', '${b64Val}')" class="rounded focus:ring-0 w-3.5 h-3.5" style="border-color: var(--layout-border); color: var(--brand-500)"><span class="text-xs truncate leading-tight" style="color: var(--layout-text)">${v}</span></label>`;
                        });
                        cc.innerHTML += htmlC + `</div></div>`;
                    }
                }
            });
        }

        function toggleDropdown(id) {
            document.querySelectorAll('.filter-dropdown').forEach(el => {
                if(el.id !== id) el.classList.add('hidden');
            });
            document.getElementById(id).classList.toggle('hidden');
        }

        function toggleF(dim, b64Val) {
            const val = b64DecodeUnicode(b64Val);
            if(!filterState[dim]) filterState[dim]=[];
            const i = filterState[dim].indexOf(val);
            if(i>-1) filterState[dim].splice(i,1); else filterState[dim].push(val);
            
            const safeSuffix = `${dim}_${b64Val.replace(/[^a-zA-Z0-9]/g,'')}`;
            const chkAdm = document.getElementById(`chk_adm_${safeSuffix}`);
            const chkCli = document.getElementById(`chk_cli_${safeSuffix}`);
            const isChecked = (i === -1);
            if(chkAdm) chkAdm.checked = isChecked;
            if(chkCli) chkCli.checked = isChecked;

            renderAll();
        }

        function resetFilters() { 
            filterState = {}; 
            activeChartFilters = {}; 
            document.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false); 
            const search = document.getElementById('globalSearch');
            if(search) search.value = '';
            renderAll(); 
        }

        function resetLayout() {
            themeConfig = { brand: '#4f46e5', paletteName: 'indigo', palette: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'] };
            layoutTheme = 'minimal';
            const initialCharts = customCharts.slice(0, 4);
            customCharts = initialCharts;
            const paletteSelect = document.getElementById('paletteSelect');
            if(paletteSelect) paletteSelect.value = 'indigo';
            const layoutSelect = document.getElementById('layoutThemeSelect');
            if(layoutSelect) layoutSelect.value = 'minimal';
            applyTheme();
            applyLayoutTheme();
            renderAll();
        }

        function analisarCurvaABC(dados) {
            if (!dados || dados.length === 0) {
                document.getElementById('abcAlert').classList.add('hidden');
                return;
            }
            
            const porParte = {};
            dados.forEach(d => {
                const parte = d.Parte || 'N√£o Informado';
                porParte[parte] = (porParte[parte] || 0) + d.Valor;
            });
            
            const sortedPartes = Object.entries(porParte).sort((a,b) => b[1] - a[1]);
            const valorTotal = sortedPartes.reduce((sum, [,val]) => sum + val, 0);
            
            if (sortedPartes.length >= 3 && valorTotal > 0) {
                const top3 = sortedPartes.slice(0, 3);
                const valorTop3 = top3.reduce((sum, [,val]) => sum + val, 0);
                const percentual = (valorTop3 / valorTotal * 100).toFixed(1);
                
                if (percentual > 50) {
                    const alert = document.getElementById('abcAlert');
                    const message = document.getElementById('abcMessage');
                    
                    message.innerHTML = `<strong>Os 3 maiores litigantes</strong> concentram <strong>${fmtMoney(valorTop3)}</strong> (<strong>${percentual}%</strong> do valor total da base filtrada):<br><br>`;
                    message.innerHTML += top3.map(([parte, valor]) => {
                        const perc = (valor / valorTotal * 100).toFixed(1);
                        return `<div class="flex items-center gap-2 mb-1 mt-1"><span class="font-bold" style="color: #f59e0b;">‚óè</span> <strong>${parte}:</strong> ${fmtMoney(valor)} <span class="opacity-75">(${perc}%)</span></div>`;
                    }).join('');
                    
                    alert.classList.remove('hidden');
                    return;
                }
            }
            
            document.getElementById('abcAlert').classList.add('hidden');
        }

        function renderAll() {
            const q = (document.getElementById('globalSearch') || {value: ''}).value.toLowerCase();
            const filtered = dStore.filter(d => {
                if(q && !d._searchText.includes(q)) return false;
                for(const dim in filterState) {
                    if(filterState[dim] && filterState[dim].length) {
                        if(dim==='Objeto') { 
                            if(!d._objectsList.some(o=>filterState[dim].includes(o))) return false; 
                        }
                        else if(Array.isArray(d[dim])) {
                            // For optional fields that are arrays (Condena√ß√£o, Acordo, Provis√£o)
                            if(!d[dim].some(val => filterState[dim].includes(val))) return false;
                        }
                        else { 
                            if(!filterState[dim].includes(d[dim])) return false; 
                        }
                    }
                }
                for(const dim in activeChartFilters) {
                    const activeVal = activeChartFilters[dim];
                    if(activeVal) {
                        if(dim==='Objeto') { 
                            if(!d._objectsList.includes(activeVal)) return false; 
                        }
                        else if(Array.isArray(d[dim])) {
                            // For optional fields that are arrays
                            if(!d[dim].includes(activeVal)) return false;
                        }
                        else if(Object.keys(d._allData).includes(dim)) { 
                            if(d._allData[dim] !== activeVal) return false; 
                        } 
                        else { 
                            if(d[dim] !== activeVal) return false; 
                        }
                    }
                }
                return true;
            });

            const sum = filtered.reduce((a,b)=>a+b.Valor,0);
            const prov = filtered.filter(d=>String(d.Risco).toLowerCase().includes('prov')).reduce((a,b)=>a+b.Valor,0);
            document.getElementById('kTotal').innerText = filtered.length;
            document.getElementById('kTotalVal').innerText = fmtMoney(sum);
            document.getElementById('kRiskProv').innerText = fmtMoney(prov);
            document.getElementById('kAvg').innerText = fmtMoney(filtered.length?sum/filtered.length:0);
            document.getElementById('tableCount').innerText = `${filtered.length} processos`;

            analisarCurvaABC(filtered);

            const grid = document.getElementById('chartsGrid'); 
            grid.innerHTML = ''; 
            
            customCharts.forEach(cfg => {
                const hasValidData = filtered.some(d => {
                    if (cfg.x === 'Objeto') return d._objectsList && d._objectsList.length > 0;
                    const val = d[cfg.x] || d._allData[cfg.x];
                    return val && val !== '' && val !== 'N/D' && val !== 'N√£o Informado' && val !== 'null' && val !== null;
                });
                
                if (!hasValidData) return;
                
                const wrap = document.createElement('div');
                wrap.className = "glass p-6 rounded-2xl flex flex-col h-80 card card-chart break-inside-avoid relative group";
                
                let resetBtn = '';
                if(activeChartFilters[cfg.x]) {
                    wrap.classList.add('ring-2', 'ring-brand-500');
                    resetBtn = `<button onclick="clearChartFilter('${cfg.x}')" class="absolute top-4 right-12 text-[9px] bg-brand-500 text-white px-2 py-1 rounded shadow animate-pulse">Limpar Filtro</button>`;
                }

                let note = cfg.x==='Objeto' ? '<p class="text-[9px] mt-2 italic text-center border-t pt-2" style="border-color: var(--layout-border); color: #9CA3AF">* Top Ocorr√™ncias + Agrupamento \"Outros\"</p>' : '';
                
                wrap.innerHTML = `${resetBtn}<div class="flex justify-between items-center mb-4 no-print"><h4 class="font-black text-xs uppercase tracking-wide" style="color: var(--layout-text)">${cfg.title}</h4><button onclick="removeChart('${cfg.id}')" class="text-slate-300 hover:text-rose-500 transition-colors"><i class="fas fa-trash"></i></button></div><div class="flex-1 min-h-0 relative"><canvas id="canv_${cfg.id}"></canvas></div>${note}<div class="resize-handle" style="color: var(--layout-text);"></div>`;
                grid.appendChild(wrap);
                
                const resizeObserver = new ResizeObserver(() => {
                    const chartInstance = Chart.getChart(`canv_${cfg.id}`);
                    if (chartInstance) chartInstance.resize();
                });
                resizeObserver.observe(wrap);

                const agg = {};
                
                if(cfg.x === 'Objeto') {
                    filtered.forEach(d => {
                        d._objectsList.forEach(obj => {
                            if(!agg[obj]) agg[obj] = [];
                            if(cfg.y === 'count') {
                                if(!agg[obj].includes(d.Numero)) agg[obj].push(d.Numero);
                            } else {
                                let rawVal = d._allData[cfg.yCol || mappedValueColumn] || d.Valor;
                                if(typeof rawVal !== 'number') rawVal = parseVal(rawVal);
                                const dividedVal = rawVal / d._objectsList.length;
                                agg[obj].push(dividedVal);
                            }
                        });
                    });
                } else {
                    filtered.forEach(d => {
                        let keys = [];
                        const val = d[cfg.x];
                        
                        // Handle optional fields that are arrays (Condena√ß√£o, Acordo, Provis√£o)
                        if(Array.isArray(val)) {
                            keys = val;
                        } else if(val) {
                            keys = [val];
                        } else if(d._allData[cfg.x]) {
                            keys = [d._allData[cfg.x]];
                        } else {
                            keys = ['N/D'];
                        }

                        keys.forEach(k => {
                            if(!agg[k]) agg[k] = [];
                            if(cfg.y === 'count') {
                                agg[k].push(1);
                            } else {
                                let rawVal = d._allData[cfg.yCol || mappedValueColumn] || d.Valor;
                                if(typeof rawVal !== 'number') rawVal = parseVal(rawVal);
                                agg[k].push(rawVal);
                            }
                        });
                    });
                }

                let sortedData = Object.entries(agg).map(([k,v]) => {
                    let res = 0;
                    if(cfg.y === 'count') {
                        res = cfg.x === 'Objeto' ? v.length : v.reduce((a,b)=>a+b,0);
                    } else if(cfg.y === 'sum') {
                        res = v.reduce((a,b)=>a+b,0);
                    } else {
                        res = v.reduce((a,b)=>a+b,0) / v.length;
                    }
                    return [k, res];
                }).sort((a,b)=>b[1]-a[1]);

                let finalData = sortedData;
                let bgColors = [];
                const limit = cfg.type === 'line' ? 12 : (['bar_h', 'bar'].includes(cfg.type) ? 8 : 9);

                if (sortedData.length > limit) {
                    const topN = sortedData.slice(0, limit);
                    const others = sortedData.slice(limit).reduce((acc, curr) => acc + curr[1], 0);
                    finalData = topN;
                    if (others > 0) finalData.push(['Outros', others]);
                    bgColors = chroma.scale(themeConfig.palette).colors(finalData.length - (others>0?1:0));
                    if(others>0) bgColors.push('#cbd5e1'); 
                } else {
                    bgColors = chroma.scale(themeConfig.palette).colors(Math.max(finalData.length,2));
                }

                const chartConfig = {
                    type: cfg.type.replace('_h',''),
                    data: {
                        labels: finalData.map(d=>d[0]),
                        datasets: [{ 
                            data: finalData.map(d=>d[1]), 
                            backgroundColor: cfg.type === 'line' ? 'rgba(79, 70, 229, 0.1)' : bgColors,
                            borderColor: cfg.type === 'line' ? themeConfig.brand : 'transparent',
                            borderWidth: cfg.type === 'line' ? 3 : 0,
                            fill: cfg.type === 'line',
                            tension: cfg.type === 'line' ? 0.4 : 0,
                            pointRadius: cfg.type === 'line' ? 4 : 0,
                            pointHoverRadius: cfg.type === 'line' ? 6 : 0,
                            pointBackgroundColor: cfg.type === 'line' ? themeConfig.brand : 'transparent',
                            borderRadius: ['bar', 'bar_h'].includes(cfg.type) ? 6 : 0
                        }]
                    },
                    options: { 
                        indexAxis: cfg.type==='bar_h'?'y':'x', 
                        maintainAspectRatio: false, 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                display: ['doughnut', 'pie', 'polarArea'].includes(cfg.type), 
                                position:'right', 
                                labels: { 
                                    boxWidth: 12, 
                                    font: {size: 11, weight: 600},
                                    padding: 10,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const formatted = cfg.y === 'count' ? value : formatValue(value, cfg.yCol || mappedValueColumn);
                                                return {
                                                    text: `${label}: ${formatted}`,
                                                    fillStyle: data.datasets[0].backgroundColor[i] || data.datasets[0].backgroundColor,
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                } 
                            },
                            tooltip: { 
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 12,
                                callbacks: { 
                                    label: (c) => {
                                        if(cfg.y === 'count') return `Quantidade: ${c.raw}`;
                                        return `Valor: ${formatValue(c.raw, cfg.yCol || mappedValueColumn)}`;
                                    }
                                } 
                            }
                        },
                        scales: {}
                    }
                };

                if(!['doughnut', 'pie', 'polarArea', 'radar'].includes(cfg.type)) {
                    chartConfig.options.scales.y = {
                        display: true,
                        beginAtZero: true,
                        ticks: {
                            font: { size: 10, weight: 500 },
                            color: '#9CA3AF',
                            padding: 8,
                            autoSkip: true,
                            maxTicksLimit: cfg.type === 'bar_h' ? 10 : 6,
                            callback: function(val) {
                                if (cfg.type === 'bar_h') {
                                    let label = this.getLabelForValue(val);
                                    return label.length > 25 ? label.substr(0, 25) + '...' : label;
                                }
                                if(cfg.y === 'count') return val;
                                return formatValue(val, cfg.yCol || mappedValueColumn);
                            }
                        },
                        grid: {
                            color: 'rgba(229, 231, 235, 0.5)',
                            drawBorder: false
                        }
                    };
                    
                    chartConfig.options.scales.x = {
                        display: true,
                        ticks: {
                            font: { size: 10, weight: 500 },
                            color: '#9CA3AF',
                            padding: 8,
                            maxRotation: 45,
                            minRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10,
                            callback: function(val) {
                                if (cfg.type === 'bar_h') {
                                    if(cfg.y === 'count') return val;
                                    return formatValue(val, cfg.yCol || mappedValueColumn);
                                }
                                let label = this.getLabelForValue(val);
                                return label.length > 15 ? label.substr(0, 15) + '...' : label;
                            }
                        },
                        grid: {
                            display: cfg.type === 'bar_h' || cfg.type === 'line',
                            color: 'rgba(229, 231, 235, 0.3)',
                            drawBorder: false
                        }
                    };
                }

                if(cfg.type === 'radar') {
                    chartConfig.options.scales = {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                font: { size: 10 },
                                backdropColor: 'transparent',
                                callback: function(val) {
                                    if(cfg.y === 'count') return val;
                                    return formatValue(val, cfg.yCol || mappedValueColumn);
                                }
                            },
                            grid: { color: 'rgba(229, 231, 235, 0.5)' },
                            angleLines: { color: 'rgba(229, 231, 235, 0.5)' }
                        }
                    };
                }

                chartConfig.options.onClick = (e, els) => {
                    if(els.length > 0) {
                        const i = els[0].index;
                        const label = finalData[i][0];
                        if(label !== 'Outros') { 
                            activeChartFilters[cfg.x] = label; 
                            renderAll(); 
                        }
                    }
                };

                chartConfig.options.onHover = (e, els) => e.native.target.style.cursor = els.length ? 'pointer' : 'default';

                new Chart(document.getElementById(`canv_${cfg.id}`), chartConfig);
            });

            document.getElementById('dataTable').innerHTML = filtered.slice(0,50).map((d,i) => `<tr class="cursor-pointer border-b last:border-0 transition-colors" style="border-color: var(--layout-border)" onclick="openDetail(${i})">
                    <td class="px-6 py-4 font-bold font-mono text-[11px] whitespace-nowrap" style="color: var(--layout-text)">${d.Numero}</td>
                    <td class="px-6 py-4"><div class="font-bold text-xs" style="color: var(--layout-text)">${d.Cliente}</div><div class="text-slate-400 text-[10px] mt-0.5">vs ${d.Parte}</div></td>
                    <td class="px-6 py-4"><div class="line-clamp-2 text-xs w-48" style="color: var(--layout-text)" title="${d.Objeto}">${d.Objeto}</div></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-[10px] font-medium" style="background: var(--layout-accent); color: var(--layout-text)">${d.Filial}</span></td>
                    <td class="px-6 py-4 text-right font-black text-xs" style="color: var(--layout-text)">${fmtMoney(d.Valor)}</td>
                </tr>`).join('');
            
            window._renderedData = filtered;
        }

        function clearChartFilter(dim) { delete activeChartFilters[dim]; renderAll(); }
        function toggleYCol() { document.getElementById('biYColDiv').classList.toggle('hidden', document.getElementById('biY').value==='count'); }
        
        function addChart() {
            const xVal = document.getElementById('biX').value;
            const yVal = document.getElementById('biY').value;
            const yColVal = yVal === 'count' ? null : (document.getElementById('biYCol').value || mappedValueColumn);
            const typeVal = document.getElementById('biType').value;
            const titleVal = document.getElementById('biTitle').value || `An√°lise de ${xVal}`;
            customCharts.push({ id: 'c'+Date.now(), x: xVal, y: yVal, yCol: yColVal, type: typeVal, title: titleVal }); 
            document.getElementById('biTitle').value = '';
            renderAll(); 
        }
        
        function removeChart(id) { 
            const chart = customCharts.find(c=>c.id===id);
            if(chart) delete activeChartFilters[chart.x];
            customCharts = customCharts.filter(c=>c.id!==id); 
            renderAll(); 
        }
        
        function updatePalette(n) { 
            themeConfig.paletteName = n; 
            themeConfig.palette = PALETTES[n]; 
            themeConfig.brand = PALETTES[n][0]; 
            applyTheme(); 
            renderAll(); 
        }
        
        function updateCustomColor(h) { 
            themeConfig.paletteName='custom'; 
            themeConfig.brand=h; 
            themeConfig.palette=chroma.scale([h,'#cbd5e1']).colors(5); 
            applyTheme(); 
            renderAll(); 
        }
        
        function applyTheme() { 
            document.documentElement.style.setProperty('--brand-500', themeConfig.brand); 
            document.documentElement.style.setProperty('--brand-600', chroma(themeConfig.brand).darken().hex()); 
        }

        function updateLayoutTheme(theme) {
            layoutTheme = theme;
            applyLayoutTheme();
        }

        function applyLayoutTheme() {
            const t = LAYOUT_THEMES[layoutTheme] || LAYOUT_THEMES.minimal;
            document.documentElement.style.setProperty('--layout-bg', t.bg);
            document.documentElement.style.setProperty('--layout-card', t.card);
            document.documentElement.style.setProperty('--layout-text', t.text);
            document.documentElement.style.setProperty('--layout-border', t.border);
            document.documentElement.style.setProperty('--layout-accent', t.accent);
            document.documentElement.style.setProperty('--layout-sidebar', t.sidebar);
            document.documentElement.style.setProperty('--layout-sidebar-text', t.sidebarText);
            document.documentElement.style.setProperty('--layout-sidebar-border', t.sidebarBorder);
            
            const select = document.getElementById('layoutThemeSelect');
            if(select) select.value = layoutTheme;
        }
        
        function openDetail(i) {
            const data = window._renderedData[i];
            const body = document.getElementById('detBody'); body.innerHTML = '';
            document.getElementById('detTitle').innerText = `Detalhes: ${data.Numero}`;
            const core = {'Cliente':data.Cliente, 'Filial':data.Filial, 'Adverso':data.Parte, 'Valor':fmtMoney(data.Valor), 'Risco':data.Risco, '√Årea':data.Area};
            Object.entries(core).forEach(([k,v]) => body.innerHTML += `<div class="border-b border-slate-100 pb-2"><label class="text-[9px] font-black uppercase text-slate-400 block tracking-wider mb-1">${k}</label><span class="font-bold text-slate-800 text-sm">${v}</span></div>`);
            if(data._objectsList.length) body.innerHTML += `<div class="col-span-1 md:col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-100 mt-2"><label class="text-[9px] font-bold text-indigo-500 uppercase block mb-2 tracking-wider">Pedidos Identificados</label><div class="flex flex-wrap gap-2">${data._objectsList.map(o=>`<span class="bg-white border border-slate-200 px-2 py-1 rounded text-xs text-slate-600 font-medium shadow-sm">${o}</span>`).join('')}</div></div>`;
            body.innerHTML += `<div class="col-span-1 md:col-span-2 pt-6"><h4 class="text-xs font-bold text-slate-800 uppercase tracking-widest border-b pb-2 mb-4">Registro Completo (Dados Originais)</h4><div class="grid grid-cols-2 gap-4"></div></div>`;
            const extraContainer = body.lastElementChild.lastElementChild;
            Object.entries(data._allData).forEach(([k,v]) => extraContainer.innerHTML += `<div class="bg-slate-50 p-2 rounded border border-slate-100"><label class="text-[8px] font-bold uppercase text-slate-400 block mb-1 truncate" title="${k}">${k}</label><span class="text-[10px] text-slate-700 font-medium break-words">${v||'(vazio)'}</span></div>`);
            document.getElementById('detailModal').classList.replace('hidden','flex');
        }
        
        function closeDetail() { document.getElementById('detailModal').classList.replace('flex','hidden'); }

        function exportConsolidatedHTML() {
            const safePayload = {
                dStore: b64EncodeUnicode(JSON.stringify(dStore)),
                customCharts: b64EncodeUnicode(JSON.stringify(customCharts)),
                themeConfig: b64EncodeUnicode(JSON.stringify(themeConfig)),
                colMapping: b64EncodeUnicode(JSON.stringify(colMapping)),
                logoData: b64EncodeUnicode(JSON.stringify(logoData)),
                layoutTheme: layoutTheme,
                numericColumns: numericColumns,
                mappedValueColumn: mappedValueColumn
            };

            const clone = document.documentElement.cloneNode(true);
            const adminPanel = clone.querySelector('#adminPanel');
            if(adminPanel) adminPanel.remove();
            const loader = clone.querySelector('#pageLoader');
            if(loader) loader.style.opacity = '1';

            const style = clone.querySelector('style');
            if(style) style.textContent += "\nbody.client-mode .admin-panel { display: none !important; } body.client-mode .client-controls { display: flex !important; }";

            const dataScript = clone.querySelector('#consolidated-data');
            if(dataScript) dataScript.textContent = JSON.stringify(safePayload);

            const htmlContent = `<!DOCTYPE html>\n${clone.outerHTML}`;
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Dashboard_Juridico_LexOpsInsight.html';
            a.click();
        }
    </script>
</body>
</html>

